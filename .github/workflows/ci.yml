# This workflow will run tests using node and then publish a package to GitHub Packages when a release is created
# For more information see: https://help.github.com/actions/language-and-framework-guides/publishing-nodejs-packages

name: publish-nplus-tv

# è§¦å‘å·¥ä½œæµç¨‹çš„äº‹ä»¶,åœ¨åˆ†æ”¯å‘ç”Ÿpushäº‹ä»¶æ—¶è§¦å‘
on: [push]

# æŒ‰é¡ºåºè¿è¡Œä½œä¸š
jobs:
  publish-nplus-tv-test:
    if: github.ref_name == 'develop'
    # æŒ‡å®šè™šæ‹Ÿæœºç¯å¢ƒ
    runs-on: ubuntu-latest

    # å·¥ä½œæµç¨‹ä¸­ä½œä¸šçš„ç¯å¢ƒå˜é‡
    env:
      ENV_TEST: test

    steps:
      - uses: actions/checkout@v3
      - run: echo "ğŸ’¡ The message ${{ github.ref_name }}"

      - uses: actions/setup-node@v3
        with:
          node-version: "14"
      - run: node -v

      - name: Extract branch name
        run: echo "##[set-output name=branch;]$(echo ${GITHUB_REF#refs/heads/})"
        id: extract_branch

      - run: echo "branch ${{steps.extract_branch.outputs.branch}}"

      - name: Install yarn
        run: npm i yarn -g

      - name: Install dependencies
        run: yarn install

      - name: Build
        run: yarn build:$ENV_TEST

      - uses: manyuanrong/setup-ossutil@master
        with:
          endpoint: oss-cn-shenzhen.aliyuncs.com
          access-key-id: ${{ secrets.ACCESS_KEY_ID }}
          access-key-secret: ${{ secrets.ACCESS_KEY_SECRET }}

      - name: Deploy To OSS
        run: ossutil cp dist oss://nplus-box-tv-stg/ -rf

  publish-nplus-tv-pro:
    if: github.ref_name == 'main'
    # æŒ‡å®šè™šæ‹Ÿæœºç¯å¢ƒ
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      - run: echo "ğŸ’¡ The message ${{ github.ref_name }}"

      - uses: actions/setup-node@v3
        with:
          node-version: "14"
      - run: node -v

      - name: Extract branch name
        run: echo "##[set-output name=branch;]$(echo ${GITHUB_REF#refs/heads/})"
        id: extract_branch

      - run: echo "branch ${{steps.extract_branch.outputs.branch}}"

      - name: Install yarn
        run: npm i yarn -g

      - name: Install dependencies
        run: yarn install

      - name: Build
        run: npm run build

      - uses: manyuanrong/setup-ossutil@master
        with:
          endpoint: oss-cn-shenzhen.aliyuncs.com
          access-key-id: ${{ secrets.ACCESS_KEY_ID }}
          access-key-secret: ${{ secrets.ACCESS_KEY_SECRET }}

      - name: Deploy To OSS
        run: ossutil cp dist oss://nplus-box-tv/ -rf
